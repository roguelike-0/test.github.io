
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>レート対戦マッチング</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    .container {
      display: flex;
      flex-direction: column;
      max-width: 800px;
      margin: 0 auto;
    }
    .panel {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 10px 20px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .room-box {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 10px;
      font-size: 14px;
      word-break: break-word;
    }
    .player-info {
      display: inline-flex;
      align-items: center;
      margin: 0 5px;
    }
    .player-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      margin-right: 6px;
      background-color: #666;
    }
    .return-btn {
      display: block;
      margin: 10px auto 0;
      background: #2ecc71;
    }
    @media (max-width: 600px) {
      .container {
        width: 95%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>対戦待ち</h2>
      <p id="waitingCount">現在 0 人が参加中</p>
      <button onclick="startMatching()">対戦相手を探す</button>
      <p id="matchingStatus"></p>
    </div>
    <div class="panel">
      <h2>マッチング中の部屋一覧</h2>
      <div id="roomList"></div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let uid = "";
    let userNameMap = {};
    let userRateMap = {};
    let userIconMap = {};
    let myRoomNo = null;

    async function fetchUserData() {
      const snapshot = await db.collection("users").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        userNameMap[doc.id] = data.name || "名無し";
        userRateMap[doc.id] = data.rate || 0;
        userIconMap[doc.id] = data.iconURL || ""; // デフォルトで空
      });
    }

    function truncateName(name) {
      return name.length > 5 ? name.slice(0, 5) + "…" : name;
    }

    function renderRooms(rooms) {
      const container = document.getElementById("roomList");
      container.innerHTML = "";
      rooms.forEach((room, index) => {
        const p1 = room.player1 || "";
        const p2 = room.player2 || "";
        const name1 = truncateName(userNameMap[p1] || "名無し");
        const name2 = truncateName(userNameMap[p2] || "名無し");
        const rate1 = userRateMap[p1] || 0;
        const rate2 = userRateMap[p2] || 0;
        const icon1 = userIconMap[p1] || "https://via.placeholder.com/24";
        const icon2 = userIconMap[p2] || "https://via.placeholder.com/24";

        const div = document.createElement("div");
        div.className = "room-box";
        div.innerHTML = `
          <div><strong>No.${index + 1}</strong></div>
          <div class="player-info"><img class="player-icon" src="${icon1}">${name1} (${rate1})</div>
          VS
          <div class="player-info"><img class="player-icon" src="${icon2}">${name2} (${rate2})</div>
          ${(p1 === uid || p2 === uid) ? `<button class="return-btn" onclick="returnToRoom('${room.id}')">部屋に戻る</button>` : ""}
        `;
        container.appendChild(div);

        if (p1 === uid || p2 === uid) {
          myRoomNo = index + 1;
          localStorage.setItem("roomId", room.id);
        }
      });
    }

    function returnToRoom(roomId) {
      localStorage.setItem("roomId", roomId);
      location.href = "match_screen.html";
    }

    async function startMatching() {
      if (myRoomNo !== null) {
        alert(`すでにマッチング中です。部屋No.${myRoomNo}に戻ってください。`);
        return;
      }
      document.getElementById("matchingStatus").innerText = "対戦相手を探しています...";
      location.href = "rating_match_smartjoy_style.html";
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("ログインしてください");
        window.location.href = "index.html";
        return;
      }
      uid = user.uid;
      await fetchUserData();
      db.collection("matching_rooms").onSnapshot(snapshot => {
        const rooms = [];
        snapshot.forEach(doc => {
          rooms.push({ id: doc.id, ...doc.data() });
        });
        renderRooms(rooms);
        document.getElementById("waitingCount").innerText = `現在 ${rooms.length * 2} 人が参加中`;
      });
    });
  </script>
</body>
</html>
