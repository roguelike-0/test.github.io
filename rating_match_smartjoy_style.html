
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>レート対戦マッチング</title>
  <style>
    body {
      background: #111;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 600px;
      margin: 0 auto;
    }
    .panel {
      background: #1e1e1e;
      padding: 20px;
      border-radius: 8px;
      width: 100%;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .return-btn.hidden {
      display: none;
    }
    table {
      width: 100%;
    }
    td {
      font-size: 14px;
      padding: 10px 0;
    }
    .player-icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 6px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel">
      <h2>対戦待ち</h2>
      <p id="waitingCount">現在 0 人が参加中</p>
      <button onclick="startMatching()">対戦相手を探す</button>
      <p id="matchingStatus"></p>
    </div>
    <div class="panel">
      <h2>マッチング中の部屋一覧</h2>
      <table id="roomList"><tbody></tbody></table>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let uid = "";
    let userNameMap = {};
    let userRateMap = {};
    let userIconMap = {};
    let myRoomNo = null;

    async function fetchUserNames() {
      const snapshot = await db.collection("users").get();
      snapshot.forEach(doc => {
        const data = doc.data();
        userNameMap[doc.id] = data.name || "名無し";
        userRateMap[doc.id] = data.rate || "???";
        userIconMap[doc.id] = data.icon || "https://placehold.jp/30x30.png";
      });
    }

    function renderRooms(rooms) {
      const tbody = document.querySelector("#roomList tbody");
      tbody.innerHTML = "";
      rooms.forEach((room, index) => {
        const p1 = userNameMap[room.player1] || "名無し";
        const p2 = userNameMap[room.player2] || "名無し";
        const r1 = userRateMap[room.player1] || "???";
        const r2 = userRateMap[room.player2] || "???";
        const i1 = userIconMap[room.player1];
        const i2 = userIconMap[room.player2];
        const isSelf = (room.player1 === uid || room.player2 === uid);
        const showButton = isSelf ? "" : "hidden";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            No.${index + 1}<br>
            <img class="player-icon" src="${i1}">${p1}（${r1}）<br>
            VS<br>
            <img class="player-icon" src="${i2}">${p2}（${r2}）<br>
            <button class="return-btn ${showButton}" onclick="returnToRoom('${room.id}')">部屋に戻る</button>
          </td>
        `;
        tbody.appendChild(tr);
        if (room.player1 === uid || room.player2 === uid) {
          myRoomNo = index + 1;
          localStorage.setItem("roomId", room.id);
        }
      });
    }

    function returnToRoom(roomId) {
      localStorage.setItem("roomId", roomId);
      location.href = "match_screen.html";
    }

    async function startMatching() {
      if (myRoomNo !== null) {
        alert(`すでにマッチング中です。部屋No.${myRoomNo}に戻ってください。`);
        return;
      }
      document.getElementById("matchingStatus").innerText = "対戦相手を探しています...";
      location.href = "rating_match_smartjoy_style.html";
    }

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("ログインしてください");
        window.location.href = "index.html";
        return;
      }
      uid = user.uid;
      await fetchUserNames();
      db.collection("matching_rooms").onSnapshot(snapshot => {
        const rooms = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          rooms.push({ id: doc.id, ...data });
        });
        renderRooms(rooms);
        document.getElementById("waitingCount").innerText = `現在 ${rooms.length * 2} 人が参加中`;
      });
    });
  </script>
</body>
</html>
