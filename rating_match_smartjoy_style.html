<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>レート対戦マッチング</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      justify-content: space-between;
      padding: 20px;
    }
    .left, .right {
      width: 48%;
      background: #1e1e1e;
      padding: 20px;
      border-radius: 10px;
    }
    button {
      font-size: 16px;
      padding: 10px 20px;
      background: #337ab7;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .room-entry {
      background: #333;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div class="left">
    <h2>レート対戦</h2>
    <button onclick="startMatching()">対戦相手を探す</button>
    <p id="participantsCount">現在読み込み中...</p>
  </div>

  <div class="right">
    <h2>マッチング中の部屋</h2>
    <div id="roomList">読み込み中...</div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUid = "";
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("ログインしてください");
        location.href = "index.html";
        return;
      }
      currentUid = user.uid;
      loadRooms();
    });

    async function loadRooms() {
      const snapshot = await db.collection("matching_rooms").get();
      const activeRooms = snapshot.docs.filter(doc => {
        const data = doc.data();
        return data.player1 && data.player2;
      });
      document.getElementById("participantsCount").innerText = `現在 ${snapshot.size * 2}人が参加中`;

      const list = document.getElementById("roomList");
      list.innerHTML = "";

      const now = Date.now();
      snapshot.forEach(doc => {
        const data = doc.data();
        const roomId = doc.id;

        if (data.lastUpdated && now - data.lastUpdated.toMillis() > 10 * 60 * 1000) {
          db.collection("matching_rooms").doc(roomId).delete();
          return;
        }

        if (data.player1 && data.player2) {
          const div = document.createElement("div");
          div.className = "room-entry";
          const player1 = data.player1Name || "不明";
          const player2 = data.player2Name || "不明";
          div.innerHTML = `
            <strong>部屋ID:</strong> ${roomId}<br>
            ${player1} VS ${player2}<br>
            <button onclick="rejoinRoom('${roomId}')">この部屋に戻る</button>
          `;
          list.appendChild(div);
        }
      });
    }

    async function startMatching() {
      const user = auth.currentUser;
      const userDoc = await db.collection("users").doc(user.uid).get();
      const name = userDoc.data().name || "名無し";

      // すでに待機しているプレイヤーがいるか探す
      const snapshot = await db.collection("matching_rooms").where("player2", "==", null).get();
      if (!snapshot.empty) {
        const roomDoc = snapshot.docs[0];
        await db.collection("matching_rooms").doc(roomDoc.id).update({
          player2: user.uid,
          player2Name: name,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        localStorage.setItem("roomId", roomDoc.id);
        location.href = "match_screen.html";
      } else {
        // 自分が最初のプレイヤーとして部屋作成
        const newRoom = await db.collection("matching_rooms").add({
          player1: user.uid,
          player1Name: name,
          player2: null,
          player2Name: null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        localStorage.setItem("roomId", newRoom.id);
        location.href = "match_screen.html";
      }
    }

    function rejoinRoom(roomId) {
      localStorage.setItem("roomId", roomId);
      location.href = "match_screen.html";
    }

    setInterval(loadRooms, 15000);
  </script>
</body>
</html>
