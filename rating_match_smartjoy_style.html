<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>スマジョイ｜レート対戦</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      height: 100vh;
    }
    .left, .right {
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
    }
    .left {
      border-right: 1px solid #333;
    }
    button {
      font-size: 18px;
      padding: 10px 20px;
      background: #28a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    .room-list {
      margin-top: 20px;
    }
    .room-entry {
      padding: 10px;
      background: #222;
      margin-bottom: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .room-entry:hover {
      background: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="left">
      <h2>🎮 レート対戦に参加</h2>
      <p id="participantCount">現在 0 人が参加中</p>
      <button onclick="startMatching()">対戦相手を探す</button>
    </div>
    <div class="right">
      <h2>📋 現在の対戦部屋</h2>
      <div id="roomList" class="room-list"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser;

    auth.onAuthStateChanged(user => {
      if (!user) {
        alert("ログインが必要です。");
        window.location.href = "index.html";
        return;
      }
      currentUser = user;
      fetchRooms();
      setInterval(cleanUpOldRooms, 5 * 60 * 1000);
    });

    async function fetchRooms() {
      const snapshot = await db.collection("matching_rooms").get();
      const roomList = document.getElementById("roomList");
      roomList.innerHTML = "";

      let count = 0;
      snapshot.forEach(doc => {
        const data = doc.data();
        const p1 = data.player1Name || "?";
        const p2 = data.player2Name || "?";
        count += 2;

        const div = document.createElement("div");
        div.className = "room-entry";
        div.innerText = `#${doc.id}｜${p1} vs ${p2}`;
        div.onclick = () => {
          localStorage.setItem("roomId", doc.id);
          window.location.href = "match_screen.html";
        };
        roomList.appendChild(div);
      });

      document.getElementById("participantCount").innerText = `現在 ${count} 人が参加中`;
    }

    async function startMatching() {
      const userDoc = await db.collection("users").doc(currentUser.uid).get();
      const userData = userDoc.data();
      const rooms = await db.collection("matching_rooms").get();

      let joined = false;
      rooms.forEach(async doc => {
        const data = doc.data();
        if (!data.player2) {
          await db.collection("matching_rooms").doc(doc.id).update({
            player2: currentUser.uid,
            player2Name: userData.name,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          });
          localStorage.setItem("roomId", doc.id);
          joined = true;
          window.location.href = "match_screen.html";
        }
      });

      if (!joined) {
        const newDoc = await db.collection("matching_rooms").add({
          player1: currentUser.uid,
          player1Name: userData.name,
          lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
        });
        localStorage.setItem("roomId", newDoc.id);
        window.location.href = "match_screen.html";
      }
    }

    async function cleanUpOldRooms() {
      const snapshot = await db.collection("matching_rooms").get();
      const now = Date.now();

      snapshot.forEach(doc => {
        const data = doc.data();
        const updated = data.lastUpdated?.toDate().getTime();
        if (updated && (now - updated > 10 * 60 * 1000)) {
          db.collection("matching_rooms").doc(doc.id).delete();
        }
      });
    }
  </script>
</body>
</html>
