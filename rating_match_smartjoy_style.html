
<!-- HTML内容は実際のUIとマッチングロジックに基づき修正 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>レート対戦</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: sans-serif;
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      padding: 20px;
    }
    #left, #right {
      width: 45%;
    }
    button {
      padding: 10px;
      font-size: 16px;
    }
    .room-box {
      background: #222;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 10px;
    }
    .room-box button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="left">
    <h2>レート対戦</h2>
    <button onclick="startMatching()">対戦相手を探す</button>
    <p id="waitingCount">現在 0 人が待機中です</p>
  </div>
  <div id="right">
    <h3>マッチング中の部屋一覧</h3>
    <div id="roomList"></div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let uid = "";

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        alert("ログインしてください");
        window.location.href = "index.html";
        return;
      }
      uid = user.uid;
      loadRooms();
    });

    async function loadRooms() {
      const snapshot = await db.collection("matching_rooms").get();
      const roomList = document.getElementById("roomList");
      roomList.innerHTML = "";
      let count = 1;
      let alreadyMatchedRoomId = null;

      snapshot.forEach(async (doc) => {
        const data = doc.data();
        if (data.player1 && data.player2) {
          const player1Name = await getUserName(data.player1);
          const player2Name = await getUserName(data.player2);
          const div = document.createElement("div");
          div.className = "room-box";
          div.innerHTML = `No.${count} ${player1Name} VS ${player2Name}`;
          if (data.player1 === uid || data.player2 === uid) {
            const btn = document.createElement("button");
            btn.innerText = "部屋に戻る";
            btn.onclick = () => {
              localStorage.setItem("roomId", doc.id);
              window.location.href = "match_screen.html";
            };
            div.appendChild(document.createElement("br"));
            div.appendChild(btn);
            alreadyMatchedRoomId = count;
          }
          roomList.appendChild(div);
          count++;
        }
      });

      const waitSnapshot = await db.collection("waiting_users").doc("singleton").get();
      let waiting = waitSnapshot.exists ? 1 : 0;
      document.getElementById("waitingCount").innerText = `現在 ${waiting} 人が待機中です`;
    }

    async function getUserName(uid) {
      const snap = await db.collection("users").doc(uid).get();
      return snap.exists ? snap.data().name || "名無し" : "名無し";
    }

    async function startMatching() {
      const snapshot = await db.collection("matching_rooms").get();
      let count = 1;
      for (const doc of snapshot.docs) {
        const data = doc.data();
        if ((data.player1 === uid || data.player2 === uid) && data.player1 && data.player2) {
          alert(`部屋No.${count}で対戦中です。部屋に戻ってください。`);
          return;
        }
        count++;
      }
      window.location.href = "rating_match_smartjoy_style.html";
    }
  </script>
</body>
</html>
