<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>マイページ｜スマジョイ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>
<body>
  <h1>マイページ</h1>
  <form id="profile-form">
    <p>表示名：<input type="text" id="displayName" /></p>
    <p>アイコンURL：<input type="text" id="iconUrl" /></p>
    <p>スピリッツ使用キャラ：<input type="text" id="spiritsChar" /></p>
    <p>amiibo使用キャラ：<input type="text" id="amiiboChar" /></p>
    <p>一言コメント：<textarea id="comment"></textarea></p>
    <button type="submit">保存</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const firebaseConfig = {
      // ここにfirebaseConfigをコピペ
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const form = document.getElementById("profile-form");
    const displayName = document.getElementById("displayName");
    const iconUrl = document.getElementById("iconUrl");
    const spiritsChar = document.getElementById("spiritsChar");
    const amiiboChar = document.getElementById("amiiboChar");
    const comment = document.getElementById("comment");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";

      const ref = doc(db, "users", user.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const data = snap.data();
        displayName.value = data.name || "";
        iconUrl.value = data.icon || "";
        spiritsChar.value = data.spiritsCharacter || "";
        amiiboChar.value = data.amiiboCharacter || "";
        comment.value = data.comment || "";
      }

      form.onsubmit = async (e) => {
        e.preventDefault();
        await setDoc(ref, {
          name: displayName.value,
          icon: iconUrl.value,
          spiritsCharacter: spiritsChar.value,
          amiiboCharacter: amiiboChar.value,
          comment: comment.value,
        });
        alert("保存しました");
      };
    });
  </script>
</body>
</html>
