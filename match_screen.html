<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>対戦画面</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="player1Info">Player1: 読み込み中...</div>
  <div id="player2Info">Player2: 読み込み中...</div>
  <!-- ここにマッチング処理・チャット・勝敗処理が入る -->

  <!-- 以下、ランキング処理・レート表示関数 -->
  <script>
  async function updateRankings(winnerUid, loserUid) {
    const rankingsRef = db.collection("rankings").doc("amiibo").collection("players");

    const winnerSnap = await rankingsRef.doc(winnerUid).get();
    const loserSnap = await rankingsRef.doc(loserUid).get();

    const winnerUserDoc = await db.collection("users").doc(winnerUid).get();
    const loserUserDoc = await db.collection("users").doc(loserUid).get();

    const winnerProfile = winnerUserDoc.exists ? winnerUserDoc.data() : {};
    const loserProfile = loserUserDoc.exists ? loserUserDoc.data() : {};

    let winnerData = winnerSnap.exists ? winnerSnap.data() : {
      name: winnerProfile.name || "名無し",
      icon: winnerProfile.icon || "",
      character: winnerProfile.amiiboCharacter || "",
      rate: 1500
    };

    let loserData = loserSnap.exists ? loserSnap.data() : {
      name: loserProfile.name || "名無し",
      icon: loserProfile.icon || "",
      character: loserProfile.amiiboCharacter || "",
      rate: 1500
    };

    winnerData.rate += 30;
    loserData.rate -= 30;

    await rankingsRef.doc(winnerUid).set(winnerData);
    await rankingsRef.doc(loserUid).set(loserData);
  }

  // プレイヤーレートの取得と表示（マッチング時に呼び出し）
  async function displayPlayerRating(uid, elementId) {
    const ratingDoc = await db.collection("rankings").doc("amiibo").collection("players").doc(uid).get();
    let rate = 1500;
    if (ratingDoc.exists && ratingDoc.data().rate) {
      rate = ratingDoc.data().rate;
    }
    const container = document.getElementById(elementId);
    const rateEl = document.createElement("div");
    rateEl.innerText = "レート: " + rate;
    rateEl.style.fontSize = "14px";
    container.appendChild(rateEl);
  }
</script>

</body>
</html>
