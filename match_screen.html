<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>対戦画面</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
</head>
<body style="background:#111;color:white;text-align:center;">
  <h1>対戦中</h1>
  <p id="info"></p>
  <button onclick="submitResult('win')">勝ちました</button>
  <button onclick="submitResult('lose')">負けました</button>

  <script>
    const config = {
      apiKey: "AIzaSyDMVAb0htcBm2Yv3uKpJ7Kmqyvhmr21b9o",
      authDomain: "smajoy-8e047.firebaseapp.com",
      projectId: "smajoy-8e047"
    };
    firebase.initializeApp(config);
    const db = firebase.firestore();
    const auth = firebase.auth();
    let uid, opponentId;

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("ログインしてください");
        location.href = "index.html";
        return;
      }

      uid = user.uid;
      const matchDoc = await db.collection("matching").doc(uid).get();
      if (!matchDoc.exists) {
        alert("マッチング情報が見つかりません");
        location.href = "index.html";
        return;
      }

      opponentId = matchDoc.data().opponent;
      const opponentDoc = await db.collection("users").doc(opponentId).get();
      const myDoc = await db.collection("users").doc(uid).get();
      document.getElementById("info").innerText =
        `あなた(${myDoc.data().rate}) vs 相手(${opponentDoc.data().rate})`;
    });

    async function submitResult(result) {
      const resultRef = db.collection("match_result").doc(uid);
      await resultRef.set({ uid, result });

      const oppResultDoc = await db.collection("match_result").doc(opponentId).get();
      if (!oppResultDoc.exists) {
        alert("相手の結果を待っています...");
        return;
      }

      const myResult = result;
      const oppResult = oppResultDoc.data().result;

      if ((myResult === "win" && oppResult === "lose") || (myResult === "lose" && oppResult === "win")) {
        // 勝敗が一致してる場合、レート計算
        const myDoc = await db.collection("users").doc(uid).get();
        const oppDoc = await db.collection("users").doc(opponentId).get();
        const myRate = myDoc.data().rate || 1500;
        const oppRate = oppDoc.data().rate || 1500;
        const resultFactor = myResult === "win" ? 1 : 0;
        const expected = 1 / (1 + Math.pow(10, (oppRate - myRate) / 400));
        const k = 32;
        const newRate = Math.round(myRate + k * (resultFactor - expected));

        await db.collection("users").doc(uid).update({ rate: newRate });
        await db.collection("match_result").doc(uid).delete();
        await db.collection("match_result").doc(opponentId).delete();

        // ランキングに追加
        await db.collection("rankings").doc("amiibo").collection("players").doc(uid).set({
          name: myDoc.data().name || "NoName",
          rate: newRate,
          icon: myDoc.data().icon || "",
          character: myDoc.data().amiiboCharacter || ""
        });

        alert(`対戦終了！あなたの新レート: ${newRate}`);
        location.href = "index.html";
      } else {
        alert("結果が一致しません。もう一度選択してください。");
      }
    }
  </script>
</body>
</html>
